{% extends 'frontend_base.html' %}
{% load static %}

{% block main_content %}

<div class="tt-breadcrumb">
	<div class="container">
		<ul>
			<li><a href="{% url 'home' %}">Home</a></li>
			<li>Shopping Cart</li>
		</ul>
	</div>
</div>

	           {% comment %} <div id="tt-pageContent">
					<div class="container-indent nomargin">
						<div class="tt-empty-cart">
							<span class="tt-icon icon-f-39"></span>
							<h1 class="tt-title">SHOPPING CART IS EMPTY</h1>
							<p>You have no items in your shopping cart.</p>
							<a href="#" class="btn">CONTINUE SHOPPING</a>
						</div>
					</div>
				</div> {% endcomment %}

<div id="tt-pageContent">
	<div class="container-indent">
		<div class="container">
			<h1 class="tt-title-subpages noborder">REVIEW YOUR PRODUCT AND MAKE PAYMENT</h1>				
			<div class="row">
			  <div class="col-sm-10 col-sm-offset-1 col-md-8 col-md-offset-2 col-lg-9 col-lg-offset-3">
                <div class="card">
                    <div class="card-header">
                        Shipping Address
                    </div>
                    <div class="card-body">                       
                        <p class="card-text">{{order.full_name}}</p>
                        <p class="card-text">{{order.address}}</p>
                        <p class="card-text">{{order.city}}, {{order.state}}</p>
                        <p class="card-text">{{order.country}}</p>
                        <p class="card-text">{{order.email}}</p>
                        <p class="card-text">{{order.mobile}}</p>
                        {% if order.order_note %}
                         <p class="card-text">{{order.order_note}}</p>
                        {% endif %}
                        
                    </div>
                </div>	

                 <div class="card">
                    <div class="card-header">
                        Payment Methods
                    </div>
                    <div class="card-body">
                       
                        <p class="card-text">With supporting text below as a natural lead-in to additional content.</p>
                        
                    </div>
                </div>	

                 <div class="card">
                    <div class="card-header">
                        Review Product
                    </div>
                    <div class="card-body"> 
                    <div class="tt-shopcart-table">                      
                       			<table>
                                   <thead>
                                    <tr>                                   
                                        <th>Product</th>
                                        <th>Quantity</th>
                                        <th>Price</th>
                                    </tr>
                                   </thead>
							<tbody>
							{% for cart_item in cart_items %}
									<tr>									
									<td>
										<div class="tt-product-img">
											<img src="  {% static 'front_assets/images/loader.svg' %}" data-src="{{ cart_item.product.images.url }}" alt="{{cart_item.product.product_name}}">
										</div>
                                        <h2 class="tt-title">
											<a href="{{ cart_item.product.get_absolute_url }}">{{ cart_item.product.product_name }}</a>
										</h2>
									</td>							
									
									<td>
										<div class="tt-price subtotal">
											₹{{ cart_item.quantity }}
										</div>
									</td>
									<td>
										<div class="tt-price subtotal">
											₹{{ cart_item.sub_total }}
										</div>
									</td>
								</tr>
							{% endfor %}
							</tbody>
						</table>
                        </div>
                    </div>
                </div>			
                
			</div>
			<div class="col-md-3 col-lg-3">
				<div class="tt-shopcart-box tt-boredr-large">
					<div class="cart-subtotal tt-shopcart-table01" id="checkoutInfo">
						
						<h4 class="tt-title">Order Summary</h4>
						<hr>
						
						<table class="tt-shopcart-table01">
							{% include "./ajax-content/ajax-order-summary.html" %}
						</table>
						<!-- Set up a container element for the button -->
    					<div id="paypal-button-container"></div>					
					</div>
				</div>
			</div>	
		</div>
	   </form>
	</div>
</div>
</div>
{% endblock  %}
{% block ex_js %}
<!-- Include the PayPal JavaScript SDK -->
    <script src="https://www.paypal.com/sdk/js?client-id=ATBM78D7Hc3e6C0gzSZqppfjzsTbff3oxCbL8sWNuknSFHy4tlAvr1InH4V-lQZTdP70r_EsptEGF_zc&currency=USD"></script>
	<script>
	var grand_total = "{{grand_total}}";
	var url = "{% url 'payment' %}";
	var order_complete = "{% url 'order.complete' %}";
    var orderId = "{{ order.order_number }}";
    var payment_method = "PayPal";
	

	// Example POST method implementation:
	async function postData(url = '', data = {}) {
	// Default options are marked with *
	const response = await fetch(url, {
		method: 'POST', // *GET, POST, PUT, DELETE, etc.
		//mode: 'cors', // no-cors, *cors, same-origin
		//cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
		//credentials: 'same-origin', // include, *same-origin, omit
		headers: {
		'Content-Type': 'application/json',
		'X-CSRFToken': csrftoken,
		// 'Content-Type': 'application/x-www-form-urlencoded',
		},
		//redirect: 'follow', // manual, *follow, error
		//referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
		body: JSON.stringify(data) // body data type must match "Content-Type" header
	}) // parses JSON response into native JavaScript objects
	.then((response) => response.json())
  							.then((data) => {
								  window.location.href = order_complete + '?order_number='+data.order_number+'&payment_id='+data.tranId
							  });
	}
	    // Render the PayPal button into #paypal-button-container
        paypal.Buttons({
            style: {
                color:  'blue',
                shape:  'pill',
                label:  'pay',
                height: 40
            },
            // Set up the transaction
            createOrder: function(data, actions) {
                return actions.order.create({
                    purchase_units: [{
                        amount: {
                            value: grand_total
                        }
                    }]
                });
            },

            // Finalize the transaction
            onApprove: function(data, actions) {
                return actions.order.capture().then(function(details) {
					console.log(details);
					data = {	
                                orderId:orderId,
                                payment_method:payment_method,
								transId:details.id,								
								status:details.status,
								payer_email:details.payer.email_address,
								payer_fullname:details.payer.name.given_name+' '+details.payer.name.surname,
								payer_id:details.payer.payer_id,
								payer_address:details.payer.address.country_code,
								amount:grand_total,
								currency_code:details.purchase_units[0].amount.currency_code,
							};
					        postData(url, data);						
					
                    // Show a success message to the buyer
                    //alert('Transaction completed by ' + details.payer.name.given_name + '!');
                });
            }
        }).render('#paypal-button-container');
    </script>
{% endblock %}